<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Test Suggest</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
      label { display: block; font-weight: 600; margin-bottom: 6px; }
      input { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; }
      small { display:block; color:#666; margin-top:6px; }
      ul { margin: 10px 0 0; padding: 0; list-style: none; }
      li { padding: 6px 8px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 6px; background: #fafafa; }
      .error { color: #b00020; margin-top: 8px; white-space: pre-wrap; }
    </style>
  </head>
  <body>
    <h2>Test Suggest API</h2>
    <p>
      Mặc định gọi API theo các URL đúng trong dự án:
      <br />- <code>http://localhost:3000/author/suggest?q=N</code>
      <br />- <code>http://localhost:3000/book/suggest?q=N</code>
      <br />- <code>http://localhost:3000/publisher/suggest?q=N</code>
    </p>

    <div class="grid">
      <div class="card">
        <label for="bookQ">Suggest Book</label>
        <input id="bookQ" placeholder="Nhập tiền tố tên sách..." autocomplete="off" />
        <small>GET <code>/book/suggest</code></small>
        <div id="bookErr" class="error"></div>
        <ul id="bookList"></ul>
      </div>

      <div class="card">
        <label for="authorQ">Suggest Author</label>
        <input id="authorQ" placeholder="Nhập tiền tố tên tác giả..." autocomplete="off" />
        <small>GET <code>/author/suggest</code></small>
        <div id="authorErr" class="error"></div>
        <ul id="authorList"></ul>
      </div>

      <div class="card">
        <label for="publisherQ">Suggest Publisher</label>
        <input id="publisherQ" placeholder="Nhập tiền tố nhà xuất bản..." autocomplete="off" />
        <small>GET <code>/publisher/suggest</code></small>
        <div id="publisherErr" class="error"></div>
        <ul id="publisherList"></ul>
      </div>
    </div>

    <script>
      const BASE = "http://localhost:3000";

      function debounce(fn, wait = 250) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      }

      function setError(el, msg) {
        el.textContent = msg || "";
      }

      function renderList(listEl, rows, mapFn) {
        listEl.innerHTML = "";
        (rows || []).forEach((r) => {
          const li = document.createElement("li");
          li.textContent = mapFn(r);
          listEl.appendChild(li);
        });
      }

      async function suggest({ endpoint, q, errEl, listEl, mapFn }) {
        const kw = String(q || "").trim();
        if (!kw) {
          setError(errEl, "");
          listEl.innerHTML = "";
          return;
        }

        const url = `${BASE}${endpoint}?q=${encodeURIComponent(kw)}&limit=10`;

        try {
          setError(errEl, "");
          const res = await fetch(url);
          const json = await res.json().catch(() => ({}));

          if (!res.ok) {
            setError(errEl, `HTTP ${res.status}: ${JSON.stringify(json)}`);
            listEl.innerHTML = "";
            return;
          }

          renderList(listEl, json.data, mapFn);
        } catch (e) {
          setError(errEl, String(e));
          listEl.innerHTML = "";
        }
      }

      // Book
      const bookQ = document.getElementById("bookQ");
      const bookList = document.getElementById("bookList");
      const bookErr = document.getElementById("bookErr");
      bookQ.addEventListener(
        "input",
        debounce(() =>
          suggest({
            endpoint: "/book/suggest",
            q: bookQ.value,
            errEl: bookErr,
            listEl: bookList,
            mapFn: (r) => `${r.book_id} - ${r.title}`,
          })
        )
      );

      // Author
      const authorQ = document.getElementById("authorQ");
      const authorList = document.getElementById("authorList");
      const authorErr = document.getElementById("authorErr");
      authorQ.addEventListener(
        "input",
        debounce(() =>
          suggest({
            endpoint: "/author/suggest",
            q: authorQ.value,
            errEl: authorErr,
            listEl: authorList,
            mapFn: (r) => `${r.author_id} - ${r.name}`,
          })
        )
      );

      // Publisher
      const publisherQ = document.getElementById("publisherQ");
      const publisherList = document.getElementById("publisherList");
      const publisherErr = document.getElementById("publisherErr");
      publisherQ.addEventListener(
        "input",
        debounce(() =>
          suggest({
            endpoint: "/publisher/suggest",
            q: publisherQ.value,
            errEl: publisherErr,
            listEl: publisherList,
            mapFn: (r) => `${r.publisher_id} - ${r.name}`,
          })
        )
      );
    </script>
  </body>
</html>
